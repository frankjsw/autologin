name: ClawCloud API Fetch

on:
  workflow_dispatch:

jobs:
  fetch_projects:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Fetch ClawCloud Projects
        env:
          CLAW_TOKEN: ${{ secrets.CLAW_TOKEN }}
        run: |
          python - << 'EOF'
          import os
          import requests
          import json

          token = os.getenv("CLAW_TOKEN")
          if not token:
              raise Exception("❌ CLAW_TOKEN is missing!")

          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/json"
          }

          api_url = "https://ap-southeast-1.run.claw.cloud/api/projects"
          resp = requests.get(api_url, headers=headers)

          if resp.status_code == 200:
              projects = resp.json()
              print(f"✅ 成功获取 {len(projects)} 个项目:")
              for idx, project in enumerate(projects, 1):
                  print(f"{idx}. {project.get('name','未命名项目')}")
              # 保存为 JSON 文件
              with open("projects.json", "w") as f:
                  json.dump(projects, f, ensure_ascii=False, indent=2)
          else:
              print(f"❌ 获取项目失败: {resp.status_code} {resp.text}")
              resp.raise_for_status()
          EOF

      - name: Upload Projects JSON
        uses: actions/upload-artifact@v4
        with:
          name: claw_projects
          path: projects.json
